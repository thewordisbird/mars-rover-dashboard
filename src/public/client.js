// DOM Components and event listeners -----------------------------------
const root = document.getElementById('root');

// Event delegation for click event in root div
root.addEventListener('click', async event => {
    /**
     * @description Click event delegation for dynamically generated elements in the roor div.
     * @param event (obj): The event object generated by the click.
    */
    if (event.target.className.includes('camera-filter-item') ) {
        // Handle camera filter click events.
        const prevFilter = getCam();
        const prevFilterElement = document.getElementById(prevFilter);
        prevFilterElement.classList.remove('active');
        
        const currentFilterItem = event.target;
        currentFilterItem.classList.add('active');
        
        const camera = event.target.id;
        
        const photos = await fetchData('/photos', {
            rover_name: getRoverName(),
            sol: getSol(),
            page: 1,
            camera: camera
        });

        // Update Store
        pushToStore(setCamera(camera), setPhotos(photos), updateNextPage(photos.length));
     
        // Render photos.
        renderPhotos(true);
        
    } else if (event.target.classList.contains('rover-link-landing')) {
        // Handle navigation click events. (Selecting a rover from the navbar).
        window.location.hash = event.target.value;
    }
});

window.addEventListener('scroll', async () => {
    /**
     * @description Query next page of photos for the current app state when the user scrolls to the bottom of the page.
    */
    const pageBottom = document.body.scrollHeight - window.innerHeight;
    if (document.body.scrollTop === pageBottom || document.documentElement.scrollTop === pageBottom) {
        if (getNextPage()) {
            // If the nextPage value is valid query backend for photos
            const photos = await fetchData('/photos', {
                rover_name: getRoverName(),
                sol: getSol(),
                page: getNextPage(),
                camera: getCam()
            });

            // Update Store
            pushToStore(setPhotos(photos), updateNextPage(photos.length));

            // Render Photos appending new photos to current results.
            renderPhotos(false);
        }
    }
});

// Local state and route storage --------------------------------------------------
let store;
let routes;

const resetStore = () => {
    /**
     * @description Sets the global store variable to an empty Immutable Map Object.
    */
    store = Immutable.Map({});
};

const resetRoutes = () => {
    /**
     * @description Sets the global route variable to an empty Immutable Map Object.
    */
    routes = Immutable.Map({});
};

const applyUpdaters = (state, updaters) => {
    /**
     * @description Applys state updater functions to create an updated state.
     * @param state (Immutable Object): The state to be updated.
     * @param updaters (func array): Array of updater functions to apply to the state.
     * @returns (Immutable Object): Updated state.
    */
    const startState = state;
    return updaters.reduce((newState, updater) => {
        return updater(newState);
    }, startState);
};

const pushToStore = (...updaters) => {
    /**
     * @description Updates the global store variable.
     * @param updaters (func): Functions to update the state.
     * @returns (Immutable Object): Updated state.
    */
    store = applyUpdaters(store, updaters);
    return store;
};

const pushToRoutes = (...updaters) => {
    /**
     * @description Updates the global routes variable.
     * @param updaters (func): Functions to update the routes.
     * @returns (Immutable Object): Updated routes.
    */
    routes = applyUpdaters(routes, updaters);
    return routes;
};


// Immutable Modifier And Access Functions ------------------------------
const setState = (path, data, state) => {
    /**
     * @description Sets data to a path in an Immutable Object.
     * @param path (array): Path to data to be set.
     * @param data (Immutable Object): Data to be set.
     * @param state (Immutable Object): Current state to be modified.
     * @returns (Immutable Object): New application state.
    */
    return state.setIn(path, data);
};

const getState = (path, state) => {
    /**
     * @description Read the current state of the application.
     * @returns (Immutable Object) - New application state.
    */
    return state.getIn(path);
};

const updateState = (path, updater, state) => {
    /**
     * @description Updates data in an Immutable Object by applying an updater to the state.
     * @param path (array): Path to data to be set.
     * @param updater (function): Updater to be applied.
     * @param state (Immutable Object): Current state to be modified.
     * @returns (Immutable Object): New application state.
    */
    return state.updateIn(path, val => updater(val));
};

const mergeState = (data, state) => {
    /**
     * @description Merge data in an Immutable Object.
     * @param data (Immutable Object): Data to be merged.
     * @param state (Immutable Object): Current state to be modified.
     * @returns (Immutable Object) - New application state.
    */
    return state.merge(data);
};


// App Modifier And Access Functions ------------------------------------
// Abstraction on Immutable Modifiers for specific modular tasks --------
// Setters --------------------------------------------------------------
const setStartState = () => {
    /**
     * @description Creates a function to set a new start state.
     * @returns (function) - Updater Function to apply state adjustment
    */
    const data = ['Curiosity', 'Opportunity', 'Spirit'];
    return (state) => {
        return setState(['rovers'], Immutable.fromJS(data), state);
    };
};

const setManifestData = (data) => {
    /**
     * @description Creates function to set the manifest data to the state.
     * @returns (function) - Updater Function to apply state adjustment
    */
    const path = ['rover','data'];
    return (state) => {
        return setState(path, Immutable.fromJS(data), state);
    };
};

const setPhotosData = (data) => {
    /**
     * @description Creates function to set the photo data to the state.
     * @returns (function) - Updater Function to apply state adjustment
    */
    const path = ['rover', 'photos'];
    console.log("[setPhotosData, data]", data);
    return (state) => {
        return setState(path, Immutable.fromJS(data), state);
    };
};

const setPhotos = (data) => {
    /**
     * @description Creates function to set the rover photos to the state.
     * @returns (function) - Updater Function to apply state adjustment
    */
    const path = ['rover', 'photos', 'photos'];
    return (state) => {
        return setState(path, Immutable.fromJS(data), state);
    };
};

const setCamera = (camera) => {
    /**
     * @description Creates function to set the camera to the state.
     * @returns (function) - Updater Function to apply state adjustment
    */
    const path = ['rover', 'photos', 'camera'];
    return (state) => {
        return setState(path, Immutable.fromJS(camera), state);
    };
};

const setHomeRoute = () => {
    /**
     * @description Creates function to set the home route to the routes.
     * @returns (function) - Updater Function to apply routes adjustment
    */
    const path = ['#'];
    return (state) => {
        return setState(path, renderHome(), state);
    };
};

const setRoverRoutes = (rovers) => {
    /**
     * @description Creates function to set the home route to the routes.
     * @param rovers (array): Array of rovers.
     * @returns (function) - Updater Function to apply routes adjustment
    */
    console.log("[setRoverRoutes, rovers]", rovers);
    const data = rovers.reduce((acc, current) => {
        acc[`#${current.toLowerCase()}`] = renderRover(current);
        return acc;
    }, {});
    return (state) => {
        return mergeState(data, state);
    };
};


// Getters --------------------------------------------------------------
const getRovers = () => {
    /**
     * @description Get the rovers.
     * @returns (Immutable Object)
    */
    const path = ['rovers'];
    return getState(path, store);
};

const getRover = () => {
    /**
     * @description Get the current rover.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'data', 'rover'];
    return getState(path, store);
};

const getRoverName = () => {
    /**
     * @description Get the current rover name.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'data', 'rover', 'name'];
    return getState(path, store);
};

const getRoverCams = () => {
    /**
     * @description Get the cameras availible to the current rover.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'data', 'rover', 'cameras'];
    return getState(path, store);
};

const getCam = () => {
    /**
     * @description Get the current camera filter.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'photos', 'camera'];
    return getState(path, store) || 'all';
};

const getPhotos = () => {
    /**
     * @description Get the photos for the current rover.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'photos', 'photos'];
    return getState(path, store);
};

const getSol = () => {
    /**
     * @description Get the sol for the current rover.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'data', 'rover', 'max_sol'];
    return getState(path, store);
};

const getNextPage = () => {
    /**
     * @description Get the next page for the photos.
     * @returns (Immutable Object)
    */
    const path = ['rover', 'photos', 'nextPage'];
    return getState(path, store);
};


// Updaters -------------------------------------------------------------
const updateNextPage = (photosCount) => {
    /**
     * @description Increments the nextPage field on the state by one if a full page is added. Otherwise null the field.
     * @returns (function) - Updater Function to return an updated state
    */
    const increment = 1;
    const path = ['rover', 'photos', 'nextPage'];
   
    return (state) => {
        return updateState(path, (val) => photosCount < 25 ? null: val + increment, state);
    };
};


// Render View Function -------------------------------------------------
const renderHome = () => {
    /**
     * @description Function to render the home view for a rover at a given state.
     * @returns (function) - Function that will render the home html string
    */
    console.log("[renderHome]");
    return () => {
        return App();
    };
};

const renderRover = (rover) => {
    /**
     * @description Closure function to render the rover view for a rover at a given state.
     * @param rover (str): The name of the rover to be rendered.
     * @returns (function): Function that will render the rover html string for the given state.
    */
    console.log("[renderRover, rover]", rover);
    return async () => {
        /**
         * @description Render html string for a given state
         * @param state (immutable obj): The state of the application.
         * @returns (str): html string for the view of the rover at the given state.
        */
        const manifestData = await fetchData('/manifest', {rover_name: rover});
        console.log("Manifest Data", manifestData);
        
        const photos = await fetchData('/photos', {
            rover_name: rover,
            sol: manifestData.max_sol,
            camera: 'all',
            page: 1
        });

        const photosData = {
            camera: 'all',
            photos: photos,
            nextPage: 2
        };

        console.log("Photos Data", photosData);

        // Set state to store.
        pushToStore(setManifestData(manifestData), setPhotosData(photosData));

        return App();
    };
};

const renderPhotos = (fromScratch) => {
    /**
     * @description Updates the rover-photo-album element in the DOM with rover photos.
     * @param fromScratch (bool): Boolean indicating if the element is being appended or overwritten.
    */
    const element = document.getElementById('rover-photos-album');
    const photos = getPhotos();
    console.log('GET PHOTOS', photos);

    if (fromScratch) {
        element.innerHTML = RoverPhotos(photos);
    } else {
        element.innerHTML += RoverPhotos(photos);
    }
};

const renderRoute = (route) => {
    /**
     * @description Render the html for the given route
     * @returns (str): html string of compenents for the route.
    */
    return routes.get(route)();
};

const renderView = async (route, htmlDiv) => {
    /**
     * @description Applies html modification for a view to the DOM.
    */
    htmlDiv.innerHTML = await renderRoute(route);
};

const App = async () => {
    /**
     * @description Compiles components for view.
     * @param state (immutable obj): The state of the application.
     * @returns (str) - html string to be rendered.
    */
    const rovers = getRovers();
    const rover = getRover();
    const roverCams = getRoverCams();
    const camera = getCam();
    const photos = getPhotos();
    const navBar = NavBar(rovers);
    const banner = rover ? Banner(RoverBanner, rover): Banner(HomeBanner);
    const filterBar = roverCams ? FilterBar(roverCams, camera): '';
    console.log("[App, photos]", photos);
    const main = photos ? Main(RoverPhotosAlbum, photos): Main(ChooseRover, rovers);
    return `
        <header>
            <section id="nav-bar">${navBar}</section>
            <section id="banner">${banner}</section>
            <section id="filter-bar">${filterBar}</section>
        </header>
        <main>
           <section>${main}</section>
        </main>
        <footer></footer>
    `;
};


// Listen for load and hashchange events to trigger appropriate routing--
window.addEventListener('load', () => {
    // Reset Store
    resetStore();
    pushToStore(setStartState());

    // Set Rover Routes
    resetRoutes();
    pushToRoutes(setHomeRoute(), setRoverRoutes(getRovers()));
    
    // Render View
    const hash = window.location.hash;
    const route = hash ? hash: '#';
    renderView (route, root);

});

window.addEventListener('hashchange', () => {
    // Reset Store
    resetStore();
    pushToStore(setStartState());
    
    // Render View
    const hash = window.location.hash;
    const route = hash ? hash: '#';
    renderView (route, root);
});


// Components -----------------------------------------------------------
const NavBar = (rovers) => {
    /**
     * @description Creates NavBar component
     * @param rovers (immutable obj): The immutable list containing the availible rovers.
     * @returns (str): html string to be rendered.
    */
    const htmlNavItemString = rovers.reduce((htmlString, currentRover) => {
        return htmlString += `
        <li class="nav-item">
            <a class="nav-link" href="#${currentRover.toLowerCase()}">${currentRover}<span class="sr-only">(current)</span></a>
        </li>
        `;
    }, '');
   
    return `
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">Mars Rovers</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navItems" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>        
                <div class="collapse navbar-collapse" id="navItems">
                    <ul class="navbar-nav ml-auto">
                        ${htmlNavItemString}
                    </ul>
                </div>
            </div>
        </nav>`;
};

const Banner = (BannarComponent, data=null) => {
    /**
     * @description Creates Banner component
     * @param BannerComponent (function): Function to build the sub components of the banner.
     * @param data (Immutable Object): Data to be applied to the component.
     * @returns (str): html string to be rendered.
    */
    return  `
        <div class="jumbotron text-center">
            <div class="container">
                ${BannarComponent(data)}     
            </div>   
        </div> 
    `;
};

const HomeBanner = () => {
    /**
     * @description Creates Banner component for the Home page.
     * @returns (str): html string to be rendered.
    */
    return `
        <h1>Mars Rover Photo Dashboard</h1>
        <p>live status and photos for the rovers exploring the red planet</p> 
    `;
};

const RoverBanner = (rover) => {
    /**
     * @description Creates Banner component for the Rover Dashboard page.
     * @param rover (Immutable Object): Function to build the sub components of the banner.
     * @returns (str): html string to be rendered.
    */
    return `
        <h1>${rover.get('name')}</h1>
        <p class="rover-manifest-data">Launched: ${rover.get('launch_date')} | Landed: ${rover.get('landing_date')} | Status: ${rover.get('status')}<br>Max Date: ${rover.get('max_date')} | Max Sol: ${rover.get('max_sol')} | Total Photos: ${rover.get('total_photos')}</p>
    `;
};

const FilterBar = (roverCameras) => {
    /**
     * @description Creates photo filter bar.
     * @param roverCameras (immutable obj): The immutable map containing the rover camera information.
     * @returns (str): html string to be rendered.
    */
    const htmlCameraString = roverCameras.reduce((htmlString, currentCamera) => {
        return htmlString += `<div class="dropdown-item camera-filter-item" id="${currentCamera.get('abbr')}">${currentCamera.get('name')}</div>`;
    }, '<div class="dropdown-item camera-filter-item active" id="all">All</div>');

    return `
        <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
            <div class="container">
                <div class="navbar-brand">Filters</div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#filterItems" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>            
                <div class="collapse navbar-collapse" id="filterItems">                
                    <ul class="navbar-nav mr-auto">                        
                        <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="filterDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cameras</a>
                        <div class="dropdown-menu" aria-labelledby="filterDropdown">
                            ${htmlCameraString}
                        </div>                        
                    </ul>
                </div>
            </div>
        </nav>
    `;
};

const Main = (MainComponent, data) => {
    /**
     * @description Creates Main component
     * @param MainComponent (function): Function to build the sub components of the banner.
     * @param data (Immutable Object): Data to be applied to component.
     * @returns (str): html string to be rendered.
    */
    return `
        <div class="container">
            ${MainComponent(data)}
        </div>
    `;
};

const ChooseRover = (rovers) => {
    /**
     * @description Component displaying choice of rover to view dashboard.
     * @param rovers (Immutable Array): Rover options
     * @returns (str): html string to be rendered.
    */
    const roverInfo = rovers.reduce((htmlString, currentRover) => {
        return  htmlString += `
            <div class="col-md-4">
                <div class="home-rover-grid-item card">
                    <img src="/assets/images/${currentRover}.jpg" class="card-img-top" alt="${currentRover}">
                    <div class="card-body">
                        <h5 class="card-title">${currentRover}</h5>
                        <button class="btn btn-secondary rover-link-landing" value="${currentRover.toLowerCase()}">View Images Â»</button>
                    </div>
                </div>
            </div>
        `;
    }, '');

    return `
        <div class="home-rover-grid">
            <div class="row">
                ${roverInfo}
            </div>
        </div>
    `;
};

const RoverPhotosAlbum = (photos) => {
    /**
     * @description Creates photo album.
     * @param photos (immutable obj): The immutable map containing the rover photos.
     * @returns (str): html string to be rendered.
    */
    console.log("[RoverPhotosAlbum, photos]", photos);
    return `
        <div class="album">
            <div class="container">
                <div class="row row-cols-1 row-cols-sm-1 row-cols-md-3 row-cols-lg-4" id="rover-photos-album">
                ${RoverPhotos(photos)}                
                </div>
            </div>
        </div>
    `;
};

const RoverPhotos = (photos) => {
    /**
     * @description Creates photos in photo album
     * @param photos (immutable obj): The immutable map containing the rover photos.
     * @returns (str): html string to be rendered.
    */
    const startIdx = photos.size - (photos.size % 25 === 0 ? 25 : photos.size % 25);
    return photos.reduce((htmlString, currentPhoto, idx) => {
        if (idx >= startIdx) {
            return htmlString += `
                <div class="col mb-3">
                    <div class="card h-100">
                        <div class="card-img-frame">
                            <img src="${currentPhoto.get('img_src')}" class="card-img-top" alt="${currentPhoto.getIn(['rover', 'name'])} photo ${currentPhoto.get('id')} from ${currentPhoto.getIn(['camera', 'full_name'])}">
                        </div>               
                        <div class="card-body">
                            <ul>
                                <li>Camera: ${currentPhoto.getIn(['camera', 'full_name'])}</li>
                                <li>Sol: ${currentPhoto.get('sol')}</li>
                                <li>Earth Date: ${currentPhoto.get('earth_date')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
        return '';
    }, '');
};
    

// MODEL: API calls to access data
// Express API Calls ----------------------------------------------------
const fetchData = async (route, body) => {
    /**
     * @description API call to express backend to query for manifest information or photo information.
     * @param (str) url - The endpoint of the api.
     * @param (obj) body - The data to be passed to the server.
     * @returns (obj) - Requested data from the server.
    */
    const base = "http://localhost:5001/mars-rover-dashboard/us-central1/widgets";
    // const base = "http://localhost:3000";
    console.log("path", base + route);
    console.log(base + route);
    const response = await fetch(base + route, {
        method: 'POST',
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    if (!response.ok) {
        console.log('error');
        throw new Error(`HTTP error! status: ${response.status}`);
    } else {
        console.log(response);
        return response.json();
    }
};